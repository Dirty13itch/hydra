# ULTRATHINK Comprehensive Analysis & Task List
## December 18, 2025 - Full System Assessment

> Generated by Claude Code (Opus 4.5) as permanent proactive team lead
> Deep analysis of Hydra autonomous AI operating system

---

## Executive Summary

### Current System State
| Metric | Value | Status |
|--------|-------|--------|
| API Version | 2.9.0 | Excellent |
| API Endpoints | 425 | Comprehensive |
| Services Health | 15/15 | Perfect |
| Containers | 64 running | Healthy |
| Architecture Score | 99/100 | Excellent |
| Benchmark Score | 96.5% | Excellent |
| Disk Usage | 90% (148TB/164TB) | Warning |
| Active Alerts | 4 (all info-level) | OK |
| Phase Completion | Phase 12 @ 95% | Near complete |

### GPU Resources
| GPU | Location | VRAM Used | Temp | Status |
|-----|----------|-----------|------|--------|
| RTX 5090 | hydra-ai | 29.1GB/32GB | 98°F | Loaded |
| RTX 4090 | hydra-ai | 19.8GB/24GB | 84°F | Loaded |
| RTX 5070 Ti #1 | hydra-compute | 8.9GB/16GB | 120°F | Active |
| RTX 5070 Ti #2 | hydra-compute | 7.3GB/16GB | 113°F | Active |

### Key Accomplishments (Past 48 Hours)
- Dashboard GPU metrics now using Prometheus (real-time, not mock data)
- GPU cards added to Mission page with live updates
- Temperatures converted to Fahrenheit system-wide
- Refresh interval unified to 5 seconds
- Homepage SSE integration complete
- Character voice profiles for all 22 queens
- Knowledge ingest pipeline with file/URL/text/clipboard support

---

## Part 1: Immediate Fixes (Priority: CRITICAL)

### 1.1 Add Missing Auth Exemptions
**Issue:** Command Center polling endpoints return 401 errors every 30 seconds
**Impact:** Log spam, missing data in UI
**Endpoints needing exemption:**
- `/container-health/`
- `/diagnosis/*`
- `/hardware/*`
- `/self-improvement/*`

```python
# Add to EXEMPT_PREFIXES in api.py:
"/container-health",
"/diagnosis",
"/hardware",
"/self-improvement",
```

**Effort:** 5 minutes

### 1.2 Disk Space Management
**Issue:** /mnt/user at 90% (148TB/164TB)
**Impact:** Risk of running out of space for new assets/models
**Tasks:**
- [ ] Audit large directories (models, media, temp files)
- [ ] Clean temp_migration directory (2.9TB per STATE.json)
- [ ] Prune old Docker images
- [ ] Archive old session logs
- [ ] Set up automated cleanup job

**Effort:** 1-2 hours

### 1.3 LiteLLM Authentication
**Issue:** `/health` returns 401 auth error
**Impact:** Model routing may be affected
**Tasks:**
- [ ] Verify LITELLM_MASTER_KEY environment variable
- [ ] Test model list endpoint with auth
- [ ] Update any internal calls to include API key

**Effort:** 15 minutes

---

## Part 2: Command Center Enhancements (Priority: HIGH)

### 2.1 Additional Dashboard Metrics
**Status:** Core metrics working, more requested
**Tasks:**
- [ ] Add disk space widget (total/used across array)
- [ ] Add network throughput graph
- [ ] Add model load/unload controls
- [ ] Add container restart buttons
- [ ] Add inference queue depth

### 2.2 Infra Page Improvements
**Tasks:**
- [ ] Add Fahrenheit thresholds to all temperature displays
- [ ] Add per-GPU memory charts (historical)
- [ ] Add service dependency graph
- [ ] Add quick actions (restart, logs viewer)

### 2.3 New Pages/Features
**Tasks:**
- [ ] Models page - list all loaded models, switch active model
- [ ] Agents page - view/control CrewAI crews
- [ ] Knowledge page - browse Qdrant collections, ingest status
- [ ] Settings page - configure API keys, preferences

---

## Part 3: Phase 12 Completion - Empire of Broken Queens (Priority: HIGH)

### 3.1 Automated Quality Scoring (NOT STARTED)
**Purpose:** Automatically rate generated images for consistency
**Tasks:**
- [ ] CLIP embedding comparison for face consistency
- [ ] Style adherence scorer against reference images
- [ ] Technical quality checks (noise, artifacts, resolution)
- [ ] Composite score (0-100) with breakdown
- [ ] API: POST /quality/score, POST /quality/batch

**Effort:** 4-6 hours

### 3.2 Human Feedback Loop (NOT STARTED)
**Purpose:** Learn from accept/reject decisions
**Tasks:**
- [ ] Accept/reject API endpoints
- [ ] Simple review UI in Command Center
- [ ] Connect to preference learning system
- [ ] Prompt refinement from rejection patterns
- [ ] Analytics dashboard for feedback trends

**Effort:** 4-6 hours

### 3.3 End-to-End Chapter Automation (80% COMPLETE)
**Purpose:** Upload script → receive complete assets overnight
**Tasks:**
- [ ] Unified chapter processing endpoint with job queue
- [ ] Progress notifications (Discord webhook)
- [ ] Asset verification post-generation
- [ ] Morning summary report
- [ ] Retry logic for failed generations

**Effort:** 3-4 hours

### 3.4 Background Generation Pipeline
**Tasks:**
- [ ] Wire background workflow to chapter processor
- [ ] Location → style mapping for Empire settings
- [ ] Time-of-day lighting adjustments
- [ ] Add backgrounds to Ren'Py packaging

**Effort:** 2-3 hours

---

## Part 4: Inference Optimization (Priority: MEDIUM-HIGH)

### 4.1 Speculative Decoding Setup
**Research Complete:** Requires 3.5bpw main + 8B draft model
**Hardware:** Would use 56GB VRAM (both GPUs)
**Tasks:**
- [ ] Download compatible 8B draft model
- [ ] Configure TabbyAPI for speculative decoding
- [ ] Benchmark performance improvement
- [ ] Document optimal settings

**Effort:** 2-3 hours
**Potential Gain:** 2-4x inference speedup

### 4.2 Model Hot-Swapping
**Purpose:** Quick model changes without container restarts
**Tasks:**
- [ ] API endpoint to list available models
- [ ] API endpoint to load/unload models
- [ ] VRAM management (auto-unload if needed)
- [ ] Model presets for different tasks

**Effort:** 2-3 hours

### 4.3 Context Caching Optimization
**Status:** Conversation cache exists in RAM
**Tasks:**
- [ ] Tune cache size based on 190GB RAM
- [ ] Add cache hit/miss metrics
- [ ] Implement smart eviction
- [ ] Add cache warming for common prompts

**Effort:** 1-2 hours

---

## Part 5: Home Automation Integration (Priority: MEDIUM)

### 5.1 Home Assistant Connection
**Status:** Endpoints exist, no HA_TOKEN configured
**Tasks:**
- [ ] Create long-lived access token in Home Assistant
- [ ] Configure HA_TOKEN environment variable
- [ ] Test /home/status endpoint
- [ ] Implement device discovery
- [ ] Create entity state sync

**Effort:** 1-2 hours

### 5.2 Device Onboarding
**Devices:**
- [ ] Lutron Caseta (lights)
- [ ] Bond Bridge (fans, shades)
- [ ] Nest thermostat
- [ ] Ring (presence detection)

### 5.3 Presence Automations
**Tasks:**
- [ ] "Shaun leaves" → GPU eco mode, queue research
- [ ] "Shaun arrives" → restore GPU power, show status
- [ ] "Bedtime" → full GPU power, run overnight tasks

---

## Part 6: Voice Interface (Priority: MEDIUM)

### 6.1 Wake Word Integration
**Status:** Wyoming OpenWakeWord running
**Tasks:**
- [ ] Test "Hey Jarvis" activation
- [ ] Wire to voice chat pipeline
- [ ] Add conversation context from location

### 6.2 Voice Response Optimization
**Status:** Kokoro TTS @ 44ms status, 1.3s first audio
**Tasks:**
- [ ] Pre-cache common responses
- [ ] Reduce initial latency to <500ms
- [ ] Add voice personality switching

---

## Part 7: Observability & Monitoring (Priority: MEDIUM)

### 7.1 Dashboard Gaps
**Tasks:**
- [ ] Add disk I/O metrics to Grafana
- [ ] Add network latency between nodes
- [ ] Add model inference latency histogram
- [ ] Add VRAM usage over time

### 7.2 Alerting Improvements
**Current:** 31 GPU alert rules
**Tasks:**
- [ ] Add disk space alerts (<10% free)
- [ ] Add service restart alerts
- [ ] Add model load failure alerts
- [ ] Configure Discord webhook for critical alerts

### 7.3 Log Aggregation
**Status:** Loki + Promtail running
**Tasks:**
- [ ] Add log search to Command Center
- [ ] Create error pattern detection
- [ ] Add log-based alerting

---

## Part 8: Security & Reliability (Priority: MEDIUM)

### 8.1 Backup Verification
**Status:** Cron jobs for Postgres/Qdrant backups
**Tasks:**
- [ ] Test backup restoration process
- [ ] Add backup verification checks
- [ ] Document recovery procedures

### 8.2 Container Health
**Status:** 64 running, 25 healthy, 39 no healthcheck
**Tasks:**
- [ ] Add healthchecks to remaining 39 containers
- [ ] Implement auto-restart for failed containers
- [ ] Add container resource limits

### 8.3 Secrets Management
**Status:** SOPS deployed
**Tasks:**
- [ ] Audit all hardcoded credentials
- [ ] Migrate remaining secrets to SOPS
- [ ] Implement secret rotation

---

## Part 9: Documentation & Testing (Priority: LOW-MEDIUM)

### 9.1 Knowledge Files
**Tasks:**
- [ ] Update infrastructure.md with current topology
- [ ] Add Command Center documentation
- [ ] Document all 425 API endpoints
- [ ] Create troubleshooting flowcharts

### 9.2 Test Coverage
**Status:** 25 tests added
**Tasks:**
- [ ] Integration tests for critical paths
- [ ] Load testing for inference endpoints
- [ ] End-to-end tests for chapter generation

---

## Part 10: Future Phases Preparation (Priority: LOW)

### 10.1 Phase 13: Home Automation Deep Integration
- Calendar integration (Google)
- Email intelligence (Gmail read-only)
- Financial awareness (Plaid)

### 10.2 Phase 14: Multi-User Support
- Letta multi-agent deployment
- Permission system
- User onboarding flow

### 10.3 Phase 15: External Intelligence
- News aggregation (Miniflux)
- Research queue automation
- Morning briefing system

---

## Prioritized Task Queue

### Immediate (Do Now)
1. [ ] Add missing auth exemptions to api.py
2. [ ] Clean up disk space (temp_migration)
3. [ ] Verify LiteLLM authentication

### Today/Tomorrow
4. [ ] Add disk space widget to Command Center
5. [ ] Implement quality scoring for Empire assets
6. [ ] Set up Discord webhook for notifications
7. [ ] Test Home Assistant connection

### This Week
8. [ ] Complete end-to-end chapter automation
9. [ ] Add human feedback loop UI
10. [ ] Configure speculative decoding
11. [ ] Add container healthchecks
12. [ ] Implement model hot-swapping

### This Month
13. [ ] Complete Phase 12 (Empire automation)
14. [ ] Start Phase 13 (Home Assistant deep integration)
15. [ ] Voice interface optimization
16. [ ] Full documentation update

---

## Session Work Order

Based on this analysis, the recommended work order for this session:

1. **Fix auth exemptions** (5 min) - Stop the 401 log spam
2. **Disk space audit** (30 min) - Prevent space issues
3. **LiteLLM auth fix** (15 min) - Ensure model routing works
4. **Add GPU utilization to dashboard** (30 min) - Complete the GPU picture
5. **Quality scoring MVP** (2 hr) - Key Phase 12 feature
6. **Discord webhook** (30 min) - Enable notifications

Total estimated time: 4-5 hours of focused work

---

*Generated: 2025-12-18T01:10:00Z*
*Next review: After session completion*
