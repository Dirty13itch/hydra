# Home Assistant Automations for Hydra Cluster
#
# Add to your automations.yaml or include with !include

# =============================================================================
# Critical Alerts
# =============================================================================

- id: hydra_critical_alert
  alias: "Hydra: Critical Service Down"
  description: "Alert when critical services go down"
  trigger:
    - platform: state
      entity_id: binary_sensor.hydra_critical_alert
      to: "on"
  condition:
    - condition: state
      entity_id: input_boolean.hydra_notifications
      state: "on"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üî¥ Hydra Critical Alert"
        message: >
          Critical services down: {{ state_attr('sensor.hydra_cluster_status', 'critical_down') | join(', ') }}
        data:
          priority: high
          ttl: 0
          channel: critical
    - service: persistent_notification.create
      data:
        title: "Hydra Cluster Critical"
        message: >
          Critical services are down: {{ state_attr('sensor.hydra_cluster_status', 'critical_down') | join(', ') }}

          Check the cluster immediately.
        notification_id: hydra_critical

- id: hydra_critical_resolved
  alias: "Hydra: Critical Alert Resolved"
  description: "Notify when critical alert is resolved"
  trigger:
    - platform: state
      entity_id: binary_sensor.hydra_critical_alert
      to: "off"
      for:
        minutes: 2
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üü¢ Hydra Alert Resolved"
        message: "All critical services are back online"
    - service: persistent_notification.dismiss
      data:
        notification_id: hydra_critical

# =============================================================================
# Node Offline Alerts
# =============================================================================

- id: hydra_node_offline
  alias: "Hydra: Node Offline Alert"
  description: "Alert when a cluster node goes offline"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.hydra_ai_node_available
        - binary_sensor.hydra_compute_node_available
        - binary_sensor.hydra_storage_node_available
      to: "off"
      for:
        minutes: 2
  condition:
    - condition: state
      entity_id: input_boolean.hydra_notifications
      state: "on"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "‚ö†Ô∏è Hydra Node Offline"
        message: >
          {{ trigger.to_state.name | replace(' Available', '') }} is offline
    - service: persistent_notification.create
      data:
        title: "Node Offline"
        message: "{{ trigger.to_state.name | replace(' Available', '') }} has been offline for 2 minutes"
        notification_id: "hydra_node_{{ trigger.entity_id }}"

- id: hydra_node_online
  alias: "Hydra: Node Back Online"
  trigger:
    - platform: state
      entity_id:
        - binary_sensor.hydra_ai_node_available
        - binary_sensor.hydra_compute_node_available
        - binary_sensor.hydra_storage_node_available
      to: "on"
  action:
    - service: persistent_notification.dismiss
      data:
        notification_id: "hydra_node_{{ trigger.entity_id }}"

# =============================================================================
# GPU Temperature Alerts
# =============================================================================

- id: hydra_gpu_hot
  alias: "Hydra: GPU Temperature Warning"
  description: "Warn when GPU temperature exceeds threshold"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.hydra_ai_gpu_0_temperature
        - sensor.hydra_ai_gpu_1_temperature
        - sensor.hydra_compute_gpu_0_temperature
      above: 80
      for:
        minutes: 5
  condition:
    - condition: state
      entity_id: input_boolean.hydra_notifications
      state: "on"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üå°Ô∏è Hydra GPU Hot"
        message: >
          {{ trigger.to_state.name }}: {{ trigger.to_state.state }}¬∞C

- id: hydra_gpu_critical
  alias: "Hydra: GPU Temperature Critical"
  trigger:
    - platform: numeric_state
      entity_id:
        - sensor.hydra_ai_gpu_0_temperature
        - sensor.hydra_ai_gpu_1_temperature
        - sensor.hydra_compute_gpu_0_temperature
      above: 85
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üî• Hydra GPU Critical Temperature"
        message: >
          {{ trigger.to_state.name }}: {{ trigger.to_state.state }}¬∞C

          Consider reducing load or checking cooling.
        data:
          priority: high

# =============================================================================
# Power Monitoring
# =============================================================================

- id: hydra_power_high
  alias: "Hydra: High Power Draw"
  description: "Alert when total GPU power exceeds UPS budget"
  trigger:
    - platform: numeric_state
      entity_id: sensor.hydra_ai_gpu_power
      above: 700
      for:
        minutes: 2
  action:
    - service: notify.mobile_app_phone
      data:
        title: "‚ö° Hydra High Power"
        message: >
          GPU power draw: {{ states('sensor.hydra_ai_gpu_power') }}W

          Approaching UPS capacity limit.

# =============================================================================
# Daily Health Summary
# =============================================================================

- id: hydra_daily_summary
  alias: "Hydra: Daily Health Summary"
  description: "Send daily cluster health summary"
  trigger:
    - platform: time
      at: "08:00:00"
  condition:
    - condition: state
      entity_id: input_boolean.hydra_notifications
      state: "on"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üìä Hydra Daily Report"
        message: >
          Status: {{ states('sensor.hydra_cluster_status') | title }}
          Health: {{ states('sensor.hydra_health_score') }}%
          Services: {{ states('sensor.hydra_services_healthy') }}/{{ state_attr('sensor.hydra_cluster_status', 'total') }} healthy
          Model: {{ states('sensor.tabbyapi_model') }}
          GPU Power: {{ states('sensor.hydra_ai_gpu_power') }}W

# =============================================================================
# Model Switch Notification
# =============================================================================

- id: hydra_model_changed
  alias: "Hydra: Model Changed"
  description: "Notify when TabbyAPI model changes"
  trigger:
    - platform: state
      entity_id: sensor.tabbyapi_model
  condition:
    - condition: template
      value_template: "{{ trigger.from_state.state != trigger.to_state.state }}"
    - condition: template
      value_template: "{{ trigger.from_state.state not in ['unknown', 'unavailable'] }}"
  action:
    - service: notify.mobile_app_phone
      data:
        title: "üîÑ Hydra Model Changed"
        message: >
          New model: {{ trigger.to_state.state }}
          Previous: {{ trigger.from_state.state }}

# =============================================================================
# Service Recovery Actions
# =============================================================================

- id: hydra_auto_restart_litellm
  alias: "Hydra: Auto-restart LiteLLM"
  description: "Automatically restart LiteLLM if it goes down"
  trigger:
    - platform: state
      entity_id: binary_sensor.litellm_available
      to: "off"
      for:
        minutes: 5
  action:
    - service: shell_command.hydra_restart_litellm
    - delay:
        minutes: 1
    - condition: state
      entity_id: binary_sensor.litellm_available
      state: "off"
    - service: notify.mobile_app_phone
      data:
        title: "‚ö†Ô∏è LiteLLM Restart Failed"
        message: "Automatic restart of LiteLLM failed. Manual intervention required."
