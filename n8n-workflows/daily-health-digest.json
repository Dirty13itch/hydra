{
  "name": "Hydra Daily Health Digest",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 24,
              "triggerAtHour": 8
            }
          ]
        }
      },
      "id": "trigger-daily",
      "name": "Daily 8 AM",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [0, 0]
    },
    {
      "parameters": {
        "url": "http://192.168.1.244:8600/health",
        "options": {
          "timeout": 30000
        }
      },
      "id": "get-health",
      "name": "Get Cluster Health",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [220, 0]
    },
    {
      "parameters": {
        "url": "http://192.168.1.250:5000/v1/model",
        "options": {
          "timeout": 10000
        }
      },
      "id": "get-model",
      "name": "Get TabbyAPI Model",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [220, 200]
    },
    {
      "parameters": {
        "url": "http://192.168.1.203:11434/api/tags",
        "options": {
          "timeout": 10000
        }
      },
      "id": "get-ollama",
      "name": "Get Ollama Models",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [220, 400]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineAll",
        "options": {}
      },
      "id": "merge-data",
      "name": "Merge Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [440, 100]
    },
    {
      "parameters": {
        "jsCode": "const health = $input.all()[0].json;\nconst model = $input.all()[1]?.json || {};\nconst ollama = $input.all()[2]?.json || {};\n\nconst summary = health.summary;\nconst unhealthy = health.services.filter(s => s.status !== 'healthy');\n\nconst statusEmoji = {\n  'healthy': 'ðŸŸ¢',\n  'degraded': 'ðŸŸ¡',\n  'unhealthy': 'ðŸ”´',\n  'unknown': 'âšª'\n};\n\nlet message = `# Hydra Cluster Daily Digest\\n`;\nmessage += `**${new Date().toLocaleDateString('en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}**\\n\\n`;\n\n// Overall status\nmessage += `## ${statusEmoji[summary.status]} Overall Status: ${summary.status.toUpperCase()}\\n\\n`;\nmessage += `| Metric | Count |\\n|--------|-------|\\n`;\nmessage += `| Healthy | ${summary.healthy} |\\n`;\nmessage += `| Degraded | ${summary.degraded} |\\n`;\nmessage += `| Unhealthy | ${summary.unhealthy} |\\n`;\nmessage += `| Total Services | ${summary.total} |\\n\\n`;\n\n// Critical alerts\nif (summary.critical_down.length > 0) {\n  message += `## ðŸš¨ Critical Services Down\\n`;\n  summary.critical_down.forEach(s => {\n    message += `- **${s}**\\n`;\n  });\n  message += `\\n`;\n}\n\n// Unhealthy services\nif (unhealthy.length > 0) {\n  message += `## âš ï¸ Services Needing Attention\\n`;\n  unhealthy.forEach(s => {\n    message += `- ${statusEmoji[s.status]} **${s.service}** (${s.node}): ${s.message || s.status}\\n`;\n  });\n  message += `\\n`;\n}\n\n// Node status\nmessage += `## ðŸ–¥ï¸ Node Status\\n`;\nObject.entries(health.nodes).forEach(([node, stats]) => {\n  const pct = ((stats.healthy / stats.total) * 100).toFixed(0);\n  message += `- **${node}**: ${stats.healthy}/${stats.total} healthy (${pct}%)\\n`;\n});\nmessage += `\\n`;\n\n// Model info\nif (model.model_name) {\n  message += `## ðŸ¤– Active Models\\n`;\n  message += `- **TabbyAPI**: ${model.model_name}\\n`;\n  message += `  - Context: ${model.max_seq_len} tokens\\n`;\n}\n\nif (ollama.models) {\n  message += `- **Ollama**: ${ollama.models.length} models loaded\\n`;\n  ollama.models.slice(0, 3).forEach(m => {\n    message += `  - ${m.name}\\n`;\n  });\n}\n\nmessage += `\\n---\\n*Generated by Hydra Steward at ${new Date().toISOString()}*`;\n\nreturn [{\n  json: {\n    message,\n    status: summary.status,\n    unhealthy_count: summary.unhealthy,\n    critical_down: summary.critical_down\n  }\n}];"
      },
      "id": "format-digest",
      "name": "Format Digest",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 100]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-unhealthy",
              "leftValue": "={{ $json.unhealthy_count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "id": "check-issues",
      "name": "Has Issues?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [880, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $json.message }}\",\n  \"username\": \"Hydra Steward\"\n}",
        "options": {}
      },
      "id": "send-discord",
      "name": "Send to Discord",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 0]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"content\": \"{{ $json.message }}\",\n  \"username\": \"Hydra Steward\"\n}",
        "options": {}
      },
      "id": "send-discord-alert",
      "name": "Send Alert Discord",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1100, 200]
    }
  ],
  "connections": {
    "Daily 8 AM": {
      "main": [
        [
          {"node": "Get Cluster Health", "type": "main", "index": 0},
          {"node": "Get TabbyAPI Model", "type": "main", "index": 0},
          {"node": "Get Ollama Models", "type": "main", "index": 0}
        ]
      ]
    },
    "Get Cluster Health": {
      "main": [
        [{"node": "Merge Data", "type": "main", "index": 0}]
      ]
    },
    "Get TabbyAPI Model": {
      "main": [
        [{"node": "Merge Data", "type": "main", "index": 1}]
      ]
    },
    "Get Ollama Models": {
      "main": [
        [{"node": "Merge Data", "type": "main", "index": 1}]
      ]
    },
    "Merge Data": {
      "main": [
        [{"node": "Format Digest", "type": "main", "index": 0}]
      ]
    },
    "Format Digest": {
      "main": [
        [{"node": "Has Issues?", "type": "main", "index": 0}]
      ]
    },
    "Has Issues?": {
      "main": [
        [{"node": "Send Alert Discord", "type": "main", "index": 0}],
        [{"node": "Send to Discord", "type": "main", "index": 0}]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {"name": "hydra"},
    {"name": "monitoring"},
    {"name": "daily"}
  ]
}
