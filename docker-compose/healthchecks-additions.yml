# Healthcheck Additions for Unhealthy Containers
#
# These services were identified as "unhealthy" in STATE.json.
# Merge with your existing docker-compose files or apply individually.
#
# Usage:
#   docker-compose -f docker-compose.yml -f healthchecks-additions.yml up -d
#
# Or copy the healthcheck blocks into your existing service definitions.

version: "3.9"

services:
  # ===========================================
  # LETTA MEMORY LAYER
  # ===========================================

  hydra-letta:
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8283/health || wget -q --spider http://localhost:8283/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  letta-db:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U letta -d letta"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  letta-proxy:
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8600/health', timeout=5)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # OBSERVABILITY
  # ===========================================

  hydra-alertmanager:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9093/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hydra-uptime-kuma:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3001/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # AI SERVICES
  # ===========================================

  hydra-crewai:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8500/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

  hydra-mcp:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8600/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # KNOWLEDGE GRAPH
  # ===========================================

  hydra-neo4j:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:7474 || curl -sf http://localhost:7474 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ===========================================
  # WEB UIs
  # ===========================================

  homepage:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  open-webui:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/health || curl -sf http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  hydra-searxng:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # MEDIA
  # ===========================================

  Plex-Media-Server:
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:32400/identity || wget -q --spider http://localhost:32400/identity || exit 1"]
      interval: 60s
      timeout: 15s
      retries: 3
      start_period: 180s

  stash:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9999 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===========================================
  # UTILITIES
  # ===========================================

  hydra-watchtower:
    # Watchtower is a background process without HTTP endpoint
    # Use process-based healthcheck
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep -q watchtower || exit 1"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # DATABASE FIXES (for containers without curl/wget)
  # ===========================================

  hydra-postgres:
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hydra -d hydra"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hydra-redis:
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "ls32WXmttrQ6v3Jxw9bh6XmFqhCYmIC", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  hydra-qdrant:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:6333/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ===========================================
  # ADDITIONAL SERVICES (Added 2025-12-16)
  # ===========================================

  hydra-litellm:
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:4000/health || wget -q --spider http://localhost:4000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hydra-n8n:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz || curl -sf http://localhost:5678/healthz || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hydra-prometheus:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9090/-/healthy || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hydra-grafana:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hydra-promtail:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9080/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hydra-loki:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3100/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  hydra-miniflux:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8080/healthcheck || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  hydra-control-plane-ui:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3200 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  adguard:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  gpu-metrics-api:
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  wyoming-openwakeword:
    # Wyoming uses TCP socket, not HTTP
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 10400 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
