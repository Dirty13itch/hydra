version: "3.8"

# Hydra Tools API - Self-Improvement Services
# Deploy with: docker-compose -f hydra-tools-api.yml up -d

services:
  hydra-tools-api:
    container_name: hydra-tools-api
    build:
      context: ..
      dockerfile: docker/Dockerfile.hydra-tools
    image: hydra-tools-api:latest
    restart: unless-stopped
    ports:
      - "8700:8700"
    environment:
      - HYDRA_API_HOST=0.0.0.0
      - HYDRA_API_PORT=8700
      - HYDRA_DATA_DIR=/data
      - PYTHONUNBUFFERED=1
      - LETTA_DEFAULT_AGENT=agent-24d7d80f-2576-457c-be55-9cbf5390576c
      - LETTA_URL=http://192.168.1.244:8283
    volumes:
      # Persistent data for all tools
      - hydra-tools-data:/data
      # Access to cluster shared storage (optional)
      - /mnt/user/appdata/hydra-stack/data:/mnt/data:rw
      # Docker socket for sandbox execution (sibling containers)
      - /var/run/docker.sock:/var/run/docker.sock
      # Sandbox temp directory (must be host-accessible for sibling container mounts)
      - /mnt/user/appdata/hydra-tools/sandbox:/mnt/user/appdata/hydra-tools/sandbox
      # Source code for self-improvement (read-only)
      - /mnt/user/appdata/hydra-dev:/app/repo:ro
    networks:
      - hydra-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8700/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.hydra-tools.rule=Host(`tools.hydra.local`)"
      - "traefik.http.services.hydra-tools.loadbalancer.server.port=8700"
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

volumes:
  hydra-tools-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/user/appdata/hydra-tools

networks:
  hydra-network:
    external: true
