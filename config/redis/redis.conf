# Redis Configuration for Hydra Cluster
# Optimized for persistence and reliability
#
# Deploy to: /mnt/user/appdata/hydra-stack/redis/redis.conf
# Mount as: -v /mnt/user/appdata/hydra-stack/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro

################################## NETWORK #####################################

# Bind to all interfaces (Docker handles network isolation)
bind 0.0.0.0
port 6379
protected-mode no

# TCP keepalive
tcp-keepalive 300

################################## GENERAL #####################################

# Run as daemon (no for Docker)
daemonize no

# Supervision
supervised no

# PID file
pidfile /var/run/redis/redis-server.pid

# Log level
loglevel notice

# Log to stdout for Docker logging
logfile ""

# Databases (default 16)
databases 16

################################# SNAPSHOTTING #################################

# RDB snapshots - Background saves
# Save after 900 sec (15 min) if at least 1 key changed
# Save after 300 sec (5 min) if at least 10 keys changed
# Save after 60 sec if at least 10000 keys changed
save 900 1
save 300 10
save 60 10000

# Stop writes on bgsave error
stop-writes-on-bgsave-error yes

# Compress RDB files
rdbcompression yes

# RDB checksum
rdbchecksum yes

# Sanitize filenames for dump file
sanitize-dump-payload no

# RDB filename
dbfilename dump.rdb

# Remove RDB files used by replication in instances without persistence
rdb-del-sync-files no

# Working directory
dir /data

################################# APPEND ONLY MODE #############################

# Enable AOF persistence (in addition to RDB)
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# AOF directory
appenddirname "appendonlydir"

# fsync policy:
# - always: fsync after every write (safest, slowest)
# - everysec: fsync every second (good balance) [RECOMMENDED]
# - no: let OS handle it (fastest, least safe)
appendfsync everysec

# Don't fsync during BGSAVE/BGREWRITEAOF
no-appendfsync-on-rewrite no

# Auto-rewrite AOF when it's 100% bigger than last save and at least 64mb
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# Load truncated AOF files
aof-load-truncated yes

# Use RDB preamble for faster loads
aof-use-rdb-preamble yes

# AOF timestamp
aof-timestamp-enabled no

################################# MEMORY MANAGEMENT ############################

# Maximum memory
maxmemory 2gb

# Eviction policy when maxmemory is reached
# allkeys-lru: Evict any key using LRU algorithm
maxmemory-policy allkeys-lru

# LRU/LFU sample size
maxmemory-samples 5

# Evict keys on replica
replica-ignore-maxmemory yes

# Active defragmentation
activedefrag yes

################################## SLOW LOG ###################################

# Log queries slower than 10ms
slowlog-log-slower-than 10000

# Keep 128 slow queries
slowlog-max-len 128

################################## LATENCY MONITOR ############################

# Track operations slower than 100ms
latency-monitor-threshold 100

################################# CLIENTS ######################################

# Max clients (default 10000)
maxclients 10000

############################# LAZY FREEING ####################################

# Async delete for large objects
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes
replica-lazy-flush yes
lazyfree-lazy-user-del yes
lazyfree-lazy-user-flush yes

################################ THREADED I/O #################################

# Use threading for I/O (Redis 6+)
io-threads 2
io-threads-do-reads yes
